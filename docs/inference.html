---

title: Inference


keywords: fastai
sidebar: home_sidebar

summary: "Classes for inference with model ensembles using Torchscript."
description: "Classes for inference with model ensembles using Torchscript."
nb_path: "nbs/04_inference.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/04_inference.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Helper-functions">Helper functions<a class="anchor-link" href="#Helper-functions"> </a></h2><p>Gaussian weighting for merging different predictions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ScriptFunction object at 0x7f04243de860>" class="doc_header"><code>ScriptFunction object at 0x7f04243de860></code><a href="" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ScriptFunction object at 0x7f04243de860></code>()</p>
</blockquote>
<p>Returns a Gaussian window</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ScriptFunction object at 0x7f04243de810>" class="doc_header"><code>ScriptFunction object at 0x7f04243de810></code><a href="" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ScriptFunction object at 0x7f04243de810></code>()</p>
</blockquote>
<p>Returns a 2D Gaussian kernel tensor.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">gw</span> <span class="o">=</span> <span class="n">gaussian_kernel_2d</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">),</span> <span class="n">sigma_scale</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">gw</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gw</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Calculation of epistemic and aleatoric uncertainy</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ScriptFunction object at 0x7f04243dba90>" class="doc_header"><code>ScriptFunction object at 0x7f04243dba90></code><a href="" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ScriptFunction object at 0x7f04243dba90></code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ScriptFunction object at 0x7f04243dbdb0>" class="doc_header"><code>ScriptFunction object at 0x7f04243dbdb0></code><a href="" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ScriptFunction object at 0x7f04243dbdb0></code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ScriptFunction object at 0x7f04243dbbd0>" class="doc_header"><code>ScriptFunction object at 0x7f04243dbbd0></code><a href="" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ScriptFunction object at 0x7f04243dbbd0></code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tiling">Tiling<a class="anchor-link" href="#Tiling"> </a></h2><p>Functions and classes for tiling (slicing) images</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_in_slices_1d" class="doc_header"><code>get_in_slices_1d</code><a href="https://github.com/matjesg/deepflash2/tree/master/deepflash2/inference.py#L61" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_in_slices_1d</code>(<strong><code>center</code></strong>:<code>Tensor</code>, <strong><code>len_x</code></strong>:<code>int</code>, <strong><code>len_tile</code></strong>:<code>int</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_out_slices_1d" class="doc_header"><code>get_out_slices_1d</code><a href="https://github.com/matjesg/deepflash2/tree/master/deepflash2/inference.py#L67" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_out_slices_1d</code>(<strong><code>center</code></strong>:<code>Tensor</code>, <strong><code>len_x</code></strong>:<code>int</code>, <strong><code>len_tile</code></strong>:<code>int</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TileModule" class="doc_header"><code>class</code> <code>TileModule</code><a href="https://github.com/matjesg/deepflash2/tree/master/deepflash2/inference.py#L74" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TileModule</code>(<strong><code>tile_shape</code></strong>=<em><code>(512, 512)</code></em>, <strong><code>scale</code></strong>:<code>float</code>=<em><code>1.0</code></em>, <strong><code>border_padding_factor</code></strong>:<code>float</code>=<em><code>0.25</code></em>, <strong><code>max_tile_shift</code></strong>:<code>float</code>=<em><code>0.5</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Class for tiling data.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="mi">540</span>
<span class="n">os</span> <span class="o">=</span> <span class="n">ts</span><span class="o">/</span><span class="mi">2</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">TileModule</span><span class="p">(</span><span class="n">tile_shape</span><span class="o">=</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ts</span><span class="p">))</span>
<span class="n">inp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="p">,</span><span class="n">os</span><span class="p">))[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_close</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">image</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-04</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]</span>
<span class="n">SCALES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]</span>
<span class="n">SHIFTS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
<span class="n">BPFACTORS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
<span class="n">inp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">TS</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">SCALES</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">max_tile_shift</span> <span class="ow">in</span> <span class="n">SHIFTS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">border_padding_factor</span> <span class="ow">in</span> <span class="n">BPFACTORS</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">TileModule</span><span class="p">(</span><span class="n">tile_shape</span><span class="o">=</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ts</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">max_tile_shift</span><span class="o">=</span><span class="n">max_tile_shift</span><span class="p">,</span> <span class="n">border_padding_factor</span><span class="o">=</span><span class="n">border_padding_factor</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">t</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inp</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">in_slices</span><span class="p">,</span> <span class="n">out_slices</span><span class="p">,</span> <span class="n">center_points</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_slices_and_centers</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">center_points</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">center_points</span><span class="p">):</span>
                    <span class="n">ix0</span><span class="p">,</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">iy0</span><span class="p">,</span> <span class="n">iy1</span> <span class="o">=</span> <span class="n">in_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">in_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">in_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">in_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">ox0</span><span class="p">,</span> <span class="n">ox1</span><span class="p">,</span> <span class="n">oy0</span><span class="p">,</span> <span class="n">oy1</span> <span class="o">=</span> <span class="n">out_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">out_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">out_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">out_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="p">(</span><span class="n">ix1</span><span class="o">-</span><span class="n">ix0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ox1</span><span class="o">-</span><span class="n">ox0</span><span class="p">),</span> <span class="s1">&#39;Input/Output slices do not match&#39;</span>
                    <span class="k">assert</span> <span class="p">(</span><span class="n">iy1</span><span class="o">-</span><span class="n">iy0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">oy1</span><span class="o">-</span><span class="n">oy0</span><span class="p">),</span> <span class="s1">&#39;Input/Output slices do not match&#39;</span>
                    <span class="n">tile</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">cp</span><span class="p">)</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">ox0</span><span class="p">:</span><span class="n">ox1</span><span class="p">,</span> <span class="n">oy0</span><span class="p">:</span><span class="n">oy1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">ix0</span><span class="p">:</span><span class="n">ix1</span><span class="p">,</span> <span class="n">iy0</span><span class="p">:</span><span class="n">iy1</span><span class="p">]</span>
                    <span class="c1">#plt.imshow(out)</span>
                    <span class="c1">#plt.show()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="n">t_scripted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">ost</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">os</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;TileModule.onnx&#39;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">t_scripted</span><span class="p">,</span> <span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">ost</span><span class="p">,</span> <span class="n">ost</span><span class="p">])),</span> <span class="n">path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opset_version</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inference-Ensemble">Inference Ensemble<a class="anchor-link" href="#Inference-Ensemble"> </a></h2><p>Scripable module for inference with multiple models</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="InferenceEnsemble" class="doc_header"><code>class</code> <code>InferenceEnsemble</code><a href="https://github.com/matjesg/deepflash2/tree/master/deepflash2/inference.py#L143" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>InferenceEnsemble</code>(<strong><code>models</code></strong>:<code>List</code>[<code>Module</code>], <strong><code>num_classes</code></strong>:<code>int</code>, <strong><code>in_channels</code></strong>:<code>int</code>, <strong><code>channel_means</code></strong>:<code>List</code>[<code>float</code>], <strong><code>channel_stds</code></strong>:<code>List</code>[<code>float</code>], <strong><code>tile_shape</code></strong>:<code>Tuple</code>[<code>int</code>, <code>int</code>]=<em><code>(512, 512)</code></em>, <strong><code>use_gaussian</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>gaussian_kernel_sigma_scale</code></strong>:<code>float</code>=<em><code>0.125</code></em>, <strong><code>use_tta</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>border_padding_factor</code></strong>:<code>float</code>=<em><code>0.25</code></em>, <strong><code>max_tile_shift</code></strong>:<code>float</code>=<em><code>0.9</code></em>, <strong><code>scale</code></strong>:<code>float</code>=<em><code>1.0</code></em>, <strong><code>device</code></strong>:<code>str</code>=<em><code>'cpu'</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Class for model ensemble inference</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DummyModule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="s1">&#39;Dummy Module for testing&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">num_classes</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[:,:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">CHANNELS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">SCALES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">]</span>
<span class="n">IMG_SHAPES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">]</span><span class="c1">#[256, 512, 1024]</span>

<span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHANNELS</span><span class="p">:</span>
    <span class="n">channel_means</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="n">ch</span>
    <span class="n">channel_stds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span><span class="o">*</span><span class="n">ch</span>
    <span class="k">for</span> <span class="n">num_classes</span> <span class="ow">in</span> <span class="n">NUM_CLASSES</span><span class="p">:</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">DummyModule</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">sx</span> <span class="ow">in</span> <span class="n">IMG_SHAPES</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sy</span> <span class="ow">in</span> <span class="n">IMG_SHAPES</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span><span class="n">sy</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">SCALES</span><span class="p">:</span>
                    <span class="n">ensemble</span> <span class="o">=</span> <span class="n">InferenceEnsemble</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> 
                                                 <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span> 
                                                 <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                                 <span class="n">channel_means</span><span class="o">=</span><span class="n">channel_means</span><span class="p">,</span>
                                                 <span class="n">channel_stds</span><span class="o">=</span><span class="n">channel_stds</span><span class="p">,</span> 
                                                 <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
                    <span class="n">ensemble</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">ensemble</span><span class="p">)</span>
                    <span class="n">outs</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
                    <span class="n">test_eq</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
                    <span class="n">test_eq</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
                    <span class="n">test_eq</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path_pt</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;ensemble.pt&#39;</span><span class="p">)</span>
<span class="n">scripted_ensemble</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">ensemble</span><span class="p">)</span>
<span class="n">scripted_ensemble</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_pt</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path_pt</span><span class="p">)</span>
<span class="n">path_pt</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inp&quot;</span><span class="p">]</span>
    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;argmax&quot;</span><span class="p">,</span> <span class="s2">&quot;softmax&quot;</span><span class="p">,</span> <span class="s2">&quot;stdeviation&quot;</span><span class="p">]</span>
    <span class="n">dynamic_axes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;argmax&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;softmax&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;stdeviation&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
    <span class="n">path_onnx</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;ensemble.onnx&#39;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">scripted_ensemble</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">path_onnx</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opset_version</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> 
                      <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="n">output_names</span><span class="p">,</span> <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">)</span>
    
    <span class="c1">#import onnxruntime</span>
    <span class="c1">#ort_session = onnxruntime.InferenceSession(path_onnx.as_posix())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

